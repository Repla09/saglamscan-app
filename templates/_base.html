<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ t['ai_nutrition_analyzer'] }}{% endblock %} - SaglamScan</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Original Styles --- */
        :root { --primary-color: #4CAF50; --secondary-color: #607D8B; --background-light: #f1f8e9; --success-color: #2e7d32; --error-color: #c62828;}
        body { font-family: 'Roboto', sans-serif; margin: 0; background: var(--background-light); transition: padding-right 0.3s ease; }
        .navbar {
            background-color: white;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            /* CRITICAL FIX: Establish positioning context for the absolute menu */
            position: relative;
        }
        .navbar-brand img { height: 28px; width: auto; vertical-align: middle; }
        .content { padding: 20px; }
        #toast-container { position: fixed; top: 80px; right: 20px; z-index: 1002; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 25px; color: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: 600; opacity: 0; transform: translateX(100%); transition: all 0.5s ease-in-out; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.toast-success { background-color: var(--success-color); }
        .toast.toast-error { background-color: var(--error-color); }
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1001; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease-in-out; }
        #modal-overlay.active { display: flex; opacity: 1; }
        #modal-container { background-color: white; border-radius: 12px; max-width: 450px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; transform: scale(0.95); transition: transform 0.3s ease-in-out; }
        #modal-overlay.active #modal-container { transform: scale(1); }
        #modal-content { padding: 0; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 2.5em; line-height: 1; cursor: pointer; color: #aaa; }
        .close-modal:hover { color: #333; }
        .verification-banner { background-color: #fff3e0; border-bottom: 2px solid #ffcc80; padding: 10px 20px; text-align: center; font-weight: 500; color: #e65100; }
        .verification-banner button { background-color: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 15px; font-weight: 600; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.3s ease; }
        #loading-overlay .spinner { width: 60px; height: 60px; border: 7px solid #f3f3f3; border-top: 7px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        #loading-overlay p { font-size: 1.2em; font-weight: 600; color: #333; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Navbar Desktop Styles --- */
        .navbar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1200px;
        }
        .navbar-left, .navbar-right-desktop { display: flex; align-items: center; gap: 15px; }
        .navbar a { color: #333; text-decoration: none; padding: 14px 16px; font-weight: 600; cursor: pointer; border-radius: 4px; }
        .navbar-left a:hover, .navbar-right-desktop a:hover, .user-button:hover, .lang-button:hover { background-color: #f1f1f1; }
        .user-menu, .language-switcher { position: relative; display: inline-block; }
        .user-button, .lang-button { background: none; border: none; font-size: 1em; cursor: pointer; display: flex; align-items: center; gap: 8px; font-family: 'Roboto', sans-serif; font-weight: 600; color: #333; padding: 14px 16px; border-radius: 4px; }
        .lang-button { border: 2px solid #ddd; border-radius: 20px; padding: 6px 12px; font-size: 0.9em; font-weight: 700; }
        .user-icon { width: 24px; height: 24px; }
        .flag-icon { width: 22px; height: 22px; border-radius: 50%; object-fit: cover; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        .dropdown-content { display: none; position: absolute; background-color: white; min-width: 160px; box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2); z-index: 1; right: 0; border-radius: 8px; overflow: hidden; }
        .dropdown-content a { color: black; padding: 12px 16px; display: flex; gap: 10px; }
        .user-menu:hover .dropdown-content, .language-switcher:hover .dropdown-content { display: block; }

        /* --- Animated Hamburger Styles --- */
        .navbar-toggler {
            display: none;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 10px;
            z-index: 1001;
        }
        .hamburger-box { width: 24px; height: 20px; display: flex; flex-direction: column; justify-content: space-between; }
        .hamburger-line { width: 100%; height: 3px; background-color: #333; border-radius: 3px; transition: transform 0.3s ease-in-out, opacity 0.2s ease-in-out; }
        .navbar-toggler.active .line-1 { transform: translateY(8.5px) rotate(45deg); }
        .navbar-toggler.active .line-2 { opacity: 0; }
        .navbar-toggler.active .line-3 { transform: translateY(-8.5px) rotate(-45deg); }

        /* --- Mobile Menu Base Styles --- */
        .mobile-menu-links {
            display: none;
            /* CRITICAL FIX: Position as an overlay */
            position: absolute;
            top: 100%; /* Place below the navbar */
            left: 0;
            right: 0;
            width: 100%;
            flex-direction: column;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            /* Animation setup */
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            pointer-events: none;
        }
        .mobile-menu-links.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        .mobile-menu-links > a, .mobile-menu-links > div { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; }
        .mobile-menu-links .lang-button, .mobile-menu-links .user-button { justify-content: space-between; width: 100%; padding: 0; border: none; }
        .mobile-menu-links .user-button:hover, .mobile-menu-links .lang-button:hover { background-color: transparent; }
        .mobile-menu-links .dropdown-content { position: static; box-shadow: none; border-top: 1px dashed #ddd; }
        .mobile-menu-links .dropdown-content a { padding-left: 30px; border-top: 1px solid #f9f9f9; }

        /* --- Responsive Media Query --- */
        @media screen and (max-width: 992px) {
            .navbar-right-desktop { display: none; }
            .navbar-toggler { display: block; }
        }
    </style>
    {% block head_extra %}{% endblock %}
</head>
<body data-is-verified="{{ email_verified|tojson }}">
    {% if user_name and not email_verified %}
    <div class="verification-banner" id="verification-banner">
        {{ t['email_not_verified'] }}
        <button onclick="sendVerificationEmail()">{{ t['resend_email'] }}</button>
    </div>
    {% endif %}

    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-left">
                 <a href="{{ url_for('home') }}" class="navbar-brand">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="SaglamScan Logo">
                 </a>
                 <a href="{{ url_for('how_it_works') }}">{{ t['how_it_works'] }}</a>
            </div>

            <div class="navbar-right-desktop">
                <div class="language-switcher">
                    <button class="lang-button">
                        {% if lang == 'az' %}<img src="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/flags/4x3/az.svg" class="flag-icon"><span>AZ</span>{% else %}<img src="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/flags/4x3/gb.svg" class="flag-icon"><span>EN</span>{% endif %}
                    </button>
                    <div class="dropdown-content">
                        <a href="{{ url_for('set_language', lang='az') }}"><img src="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/flags/4x3/az.svg" class="flag-icon"><span>{{t['azerbaijani']}}</span></a>
                        <a href="{{ url_for('set_language', lang='en') }}"><img src="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/flags/4x3/gb.svg" class="flag-icon"><span>{{t['english']}}</span></a>
                    </div>
                </div>
                {% if user_name %}
                    <div class="user-menu">
                        <button class="user-button">
                            <svg class="user-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12,12.5c3.31,0,6-2.69,6-6s-2.69-6-6-6S6,3.19,6,6.5S8.69,12.5,12,12.5z M12,2.5c2.21,0,4,1.79,4,4s-1.79,4-4,4s-4-1.79-4-4S9.79,2.5,12,2.5z" /><path d="M12,14.5c-4.67,0-10,2.34-10,5v2h20v-2C22,16.84,16.67,14.5,12,14.5z M4.34,19.5c0.84-1.63,3.4-2.5,7.66-2.5s6.82,0.87,7.66,2.5H4.34z" /></svg>
                            <span>{{ user_name }}</span>
                        </button>
                        <div class="dropdown-content">
                            <a href="{{ url_for('account') }}">{{ t['my_account'] }}</a>
                            <a href="{{ url_for('history') }}">{{ t['scan_history'] }}</a>
                            <a id="logout-link" href="{{ url_for('logout') }}">{{ t['logout'] }}</a>
                        </div>
                    </div>
                {% else %}
                    <a id="signup-link" href="{{ url_for('signup') }}">{{ t['sign_up'] }}</a>
                    <a id="login-link" href="{{ url_for('login') }}">{{ t['login'] }}</a>
                {% endif %}
            </div>

            <button class="navbar-toggler" onclick="toggleMobileMenu()">
                <div class="hamburger-box">
                    <div class="hamburger-line line-1"></div>
                    <div class="hamburger-line line-2"></div>
                    <div class="hamburger-line line-3"></div>
                </div>
            </button>
        </div>

        <div class="mobile-menu-links" id="mobile-menu-links">
             <a href="{{ url_for('how_it_works') }}">{{ t['how_it_works'] }}</a>
            {% if user_name %}
                 <a href="{{ url_for('account') }}">{{ t['my_account'] }}</a>
                 <a href="{{ url_for('history') }}">{{ t['scan_history'] }}</a>
                 <a id="mobile-logout-link" href="{{ url_for('logout') }}">{{ t['logout'] }}</a>
            {% else %}
                <a href="#" id="mobile-signup-link">{{ t['sign_up'] }}</a>
                <a href="#" id="mobile-login-link">{{ t['login'] }}</a>
            {% endif %}
            <div class="language-switcher">
                <button class="lang-button" onclick="this.parentElement.querySelector('.dropdown-content').style.display = this.parentElement.querySelector('.dropdown-content').style.display === 'block' ? 'none' : 'block'">
                    Language
                    <svg height="20" width="20" viewBox="0 0 20 20" aria-hidden="true" focusable="false" style="display:inline-block"><path d="M4.516 7.548c0.436-0.446 1.043-0.481 1.576 0l3.908 3.747 3.908-3.747c0.533-0.481 1.141-0.446 1.574 0 0.436 0.445 0.408 1.197 0 1.615l-4.695 4.502c-0.533 0.481-1.141 0.446-1.574 0l-4.695-4.502c-0.408-0.418-0.436-1.17 0-1.615z"></path></svg>
                </button>
                <div class="dropdown-content">
                     <a href="{{ url_for('set_language', lang='en') }}"><img src="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/flags/4x3/gb.svg" class="flag-icon"><span>{{t['english']}}</span></a>
                     <a href="{{ url_for('set_language', lang='az') }}"><img src="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/flags/4x3/az.svg" class="flag-icon"><span>{{t['azerbaijani']}}</span></a>
                </div>
            </div>
        </div>
    </nav>
    <main class="content">{% block content %}{% endblock %}</main>
    <div id="modal-overlay"><div id="modal-container"><span class="close-modal" onclick="closeAuthModal()">Ã—</span><div id="modal-content"></div></div></div>
    <div id="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p id="loading-text">{{ t.get('analyzing', 'Analyzing...') }}</p>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <div id="toast-container"></div>
    <script>
        // --- Original and Corrected Scripts ---
        const firebaseConfig = { apiKey: "{{ firebase_web_api_key }}", authDomain: "nutrition-1366d.firebaseapp.com", projectId: "nutrition-1366d", storageBucket: "nutrition-1366d.appspot.com", messagingSenderId: "667763097330", appId: "1:667763097330:web:401e196cbfe19c8c49da6b" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const toastContainer = document.getElementById('toast-container');
        function showToast(message, category = 'success') { const toast = document.createElement('div'); toast.className = `toast toast-${category}`; toast.textContent = message; toastContainer.appendChild(toast); setTimeout(() => { toast.classList.add('show'); }, 10); setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 5000); }
        const modalOverlay = document.getElementById('modal-overlay'); const modalContent = document.getElementById('modal-content');
        function closeAuthModal() { modalOverlay.classList.remove('active'); modalContent.innerHTML = ''; }
        function executeScriptsInContainer(container) { const scripts = Array.from(container.getElementsByTagName('script')); scripts.forEach(oldScript => { const newScript = document.createElement('script'); Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value)); newScript.appendChild(document.createTextNode(oldScript.innerHTML)); oldScript.parentNode.replaceChild(newScript, oldScript); }); }
        async function openAuthModal(url) { try { const response = await fetch(url); if (!response.ok) throw new Error('Failed to load form'); modalContent.innerHTML = await response.text(); executeScriptsInContainer(modalContent); modalOverlay.classList.add('active'); } catch (error) { console.error('Error opening modal:', error); showToast("Could not load the form.", 'error'); } }
        const loginLink = document.getElementById('login-link'); if (loginLink) loginLink.addEventListener('click', e => { e.preventDefault(); openAuthModal(loginLink.href); });
        const signupLink = document.getElementById('signup-link'); if (signupLink) signupLink.addEventListener('click', e => { e.preventDefault(); openAuthModal(signupLink.href); });
        modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeAuthModal(); });
        function sendVerificationEmail() { const user = auth.currentUser; if (user) { user.sendEmailVerification().then(() => showToast("{{ t['verification_sent'] }}", 'success')).catch(error => showToast(`Error: ${error.message}`, 'error')); } else { showToast("{{ t['not_logged_in'] }}", 'error'); } }
        const logoutLink = document.getElementById('logout-link'); if (logoutLink) { logoutLink.addEventListener('click', (e) => { e.preventDefault(); auth.signOut().then(() => { window.location.href = logoutLink.href; }).catch((error) => { console.error('Logout Error', error); window.location.href = logoutLink.href; }); }); }
        auth.onIdTokenChanged(async (user) => { if (user) { const emailVerifiedInSession = document.body.dataset.isVerified === 'true'; if (user.emailVerified && !emailVerifiedInSession) { console.log('Email verified! Refreshing session...'); const idToken = await user.getIdToken(true); const hiddenForm = document.createElement('form'); hiddenForm.method = 'POST'; hiddenForm.action = "{{ url_for('session_login') }}"; const tokenInput = document.createElement('input'); tokenInput.type = 'hidden'; tokenInput.name = 'id_token'; tokenInput.value = idToken; hiddenForm.appendChild(tokenInput); document.body.appendChild(hiddenForm); hiddenForm.submit(); } } });
        {% with messages = get_flashed_messages(with_categories=True) %}{% if messages %}{% for category, message in messages %}showToast("{{ message|safe }}", "{{ category }}");{% endfor %}{% endif %}{% endwith %}

        function toggleMobileMenu() {
            const toggler = document.querySelector('.navbar-toggler');
            const mobileMenu = document.getElementById('mobile-menu-links');
            const isExpanded = toggler.classList.contains('active');

            if (!isExpanded) {
                const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
                document.body.style.paddingRight = `${scrollbarWidth}px`;
                document.body.style.overflow = 'hidden';
                toggler.classList.add('active');
                mobileMenu.classList.add('active');
            } else {
                toggler.classList.remove('active');
                mobileMenu.classList.remove('active');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }
        }

        const mobileLoginLink = document.getElementById('mobile-login-link');
        if (mobileLoginLink) mobileLoginLink.addEventListener('click', e => { e.preventDefault(); openAuthModal("{{ url_for('login') }}"); });
        const mobileSignupLink = document.getElementById('mobile-signup-link');
        if (mobileSignupLink) mobileSignupLink.addEventListener('click', e => { e.preventDefault(); openAuthModal("{{ url_for('signup') }}"); });
        const mobileLogoutLink = document.getElementById('mobile-logout-link');
        if (mobileLogoutLink) mobileLogoutLink.addEventListener('click', e => { e.preventDefault(); if (logoutLink) logoutLink.click(); });
    </script>
</body>
</html>
